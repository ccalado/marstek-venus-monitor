<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marstek Venus - BLE Test Tool</title>
    <meta name="description" content="Web-based battery monitoring tool for Marstek Venus batteries via Bluetooth Low Energy">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Command Info Modal -->
    <div id="infoModal" class="info-modal">
        <div class="info-modal-content">
            <span class="info-modal-close" onclick="closeInfoModal()">&times;</span>
            <div id="commandDetails" class="command-details"></div>
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div id="disclaimerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è EXPERIMENTAL SOFTWARE WARNING ‚ö†Ô∏è</div>
            
            <div class="disclaimer-text">
                <p><strong>This is highly experimental testing software for Marstek Venus batteries.</strong></p>
                
                <div class="warning-box">
                    <strong>IMPORTANT WARNINGS:</strong>
                    <ul>
                        <li>This software can send commands to your battery system</li>
                        <li>Some commands may modify battery settings or behavior</li>
                        <li>Improper use could potentially damage your equipment</li>
                        <li>This tool is for advanced users and developers only</li>
                        <li>Use in a controlled environment with proper safety precautions</li>
                    </ul>
                </div>
                
                <p><strong>By continuing, you acknowledge that:</strong></p>
                <ul>
                    <li>You understand the experimental nature of this software</li>
                    <li>You accept full responsibility for any consequences</li>
                    <li>You will not hold the developers liable for any damages</li>
                    <li>You have proper knowledge of battery systems and safety</li>
                    <li>You will use this tool at your own risk</li>
                </ul>
                
                <p><strong>Supported Equipment:</strong> Marstek Venus batteries with "MST_ACCP" and "MST-TPM" Bluetooth names.</p>
                
                <p><strong>Browser Requirements:</strong> Chrome, Edge, or Opera with Web Bluetooth support.</p>
            </div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="acceptRisk"> 
                <label for="acceptRisk">I understand the risks and agree to proceed at my own responsibility</label>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-decline" onclick="declineAndExit()">‚ùå Exit Safely</button>
                <button class="btn-accept" id="acceptBtn" disabled onclick="acceptAndContinue()">‚úÖ Accept Risk & Continue</button>
            </div>
        </div>
    </div>

    <!-- Connection Retry Dialog -->
    <div id="retryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">üîå Connection Failed</div>
            
            <div class="disclaimer-text">
                <p>Unable to connect to the Marstek device after 3 attempts.</p>
                <p>This can happen due to:</p>
                <ul>
                    <li>Device is out of range or powered off</li>
                    <li>Another app is connected to the device</li>
                    <li>Bluetooth interference or device busy</li>
                    <li>Device needs to be reset or restarted</li>
                </ul>
                <p><strong>Would you like to try connecting again?</strong></p>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-decline" onclick="cancelRetry()">‚ùå Cancel</button>
                <button class="btn-accept" onclick="retryConnection()">üîÑ Retry Connection</button>
            </div>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="main-interface" id="mainInterface">
        <div class="container">
            <h1>üîã Marstek Venus - BLE Test Tool</h1>
            <p class="subtitle">Advanced BLE monitoring and diagnostics for Marstek battery systems</p>
            
            <!-- Version Links -->
            <div style="text-align: center; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                <span style="color: #666; font-size: 14px;">üìç You're using: <strong>v2.0.1-beta</strong></span>
                <span style="margin: 0 10px;">|</span>
                <a href="https://rweijnen.github.io/marstek-venus-monitor/" style="color: #007bff; text-decoration: none;">
                    üîí Switch to v1.0.0 (Stable)
                </a>
            </div>
            
            <div class="status">
                <span>Status: <span id="status" class="disconnected">Disconnected</span></span>
                <div>
                    <button onclick="connect()" id="connectBtn" class="btn-connect">Connect to Marstek</button>
                    <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
                    <button onclick="disconnectAll()" id="disconnectAllBtn">Disconnect All</button>
                    <button onclick="forgetBluetoothDevices()" id="forgetDevicesBtn" class="btn-warning" 
                            data-tooltip="Clear stale Bluetooth pairings that may prevent connections">üóëÔ∏è Forget Devices</button>
                    <button onclick="runAllTests()" id="runAllBtn" disabled>üß™ Run All Tests</button>
                    <button onclick="clearAll()">Clear All</button>
                </div>
            </div>
            
            <!-- Connection Status Messages -->
            <div id="connectionStatus" class="connection-status" style="display: none;">
                <div id="connectionMessage"></div>
            </div>

            <!-- Command Tabs Interface -->
            <div class="command-tabs-container">
                <div class="command-tabs">
                    <button class="command-tab-button active" onclick="switchCommandTab('read')">üìñ Read</button>
                    <button class="command-tab-button" onclick="switchCommandTab('power')">‚ö° Power</button>
                    <button class="command-tab-button" onclick="switchCommandTab('system')">‚öôÔ∏è System</button>
                    <button class="command-tab-button" onclick="switchCommandTab('development')">üîß Dev</button>
                    <button class="command-tab-button" onclick="switchCommandTab('network')">üï∞ Network</button>
                    <button class="command-tab-button" onclick="switchCommandTab('advanced')">üîß Advanced</button>
                    <button class="command-tab-button" onclick="switchCommandTab('ota')">üî• OTA</button>
                </div>
                
                <!-- Command Tab Contents (Loaded Dynamically) -->
                <div id="readTab" class="command-tab active"></div>
                <div id="powerTab" class="command-tab"></div>
                <div id="systemTab" class="command-tab"></div>
                <div id="developmentTab" class="command-tab"></div>
                <div id="networkTab" class="command-tab"></div>
                <div id="advancedTab" class="command-tab"></div>
                <div id="otaTab" class="command-tab"></div>
            </div>


            <div id="dataDisplay"></div>
            
            <!-- Tabbed Log Interface -->
            <div class="log-container">
                <div class="log-tabs">
                    <button class="tab-button active" onclick="switchLogTab('activity')">Activity</button>
                    <button class="tab-button" onclick="switchLogTab('protocol')">Protocol</button>
                    <button class="tab-button" onclick="switchLogTab('errors')">Errors</button>
                </div>
                
                <div id="activityLog" class="log-tab active"></div>
                <div id="protocolLog" class="log-tab"></div>
                <div id="errorLog" class="log-tab"></div>
                
                <!-- Keep original log div for compatibility -->
                <div id="log" style="display: none;"></div>
            </div>
            
            <div class="footer">
                <p>
                    <strong>Marstek Venus Monitor</strong> - Experimental BLE Battery Diagnostics<br>
                    <a href="https://github.com/rweijnen/marstek-venus-monitor" class="github-link" target="_blank">
                        View on GitHub
                    </a> | 
                    <a href="https://github.com/tomquist/hmjs" class="github-link" target="_blank">
                        Original HMJS Project
                    </a>
                </p>
                <p id="versionInfo"><small>Version: Loading...</small></p>
                <p><small>‚ö†Ô∏è Use at your own risk - Experimental software</small></p>
            </div>
        </div>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="js/log-manager.js"></script>
    <script src="js/response-handler.js"></script>
    <script src="js/ble-protocol.js"></script>
    <script src="js/ui-controller.js"></script>
    <script type="module">
        // Import the TypeScript-compiled parser
        import { parseResponse } from './js/dist/data-parser-ts.js';
        
        // Set up the parser for global use
        window.dataParser = {
            parseResponse: parseResponse
        };
        console.log('‚úÖ TypeScript parser loaded');
    </script>
    <script src="js/integration-test.js"></script>
</body>
</html>